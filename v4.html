<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Osaka 5-Day Strategy ¬∑ AI Generated Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-body: #f4f1ea;
      --bg-card: #fdfaf6;
      --ink-main: #332c26;
      --ink-muted: #7d7266;
      --ink-accent: #a67c52;
      --border-soft: #e6ded5;
      --radius-card: 16px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-body);
      font-family: "Noto Serif TC", system-ui, sans-serif;
      color: var(--ink-main);
      -webkit-font-smoothing: antialiased;
    }

    body {
      min-height: 100vh;
      padding: 14px 10px 90px;
    }

    @media (min-width: 768px) {
      body {
        display: flex;
        justify-content: center;
        padding: 32px 20px 110px;
      }
    }

    .app-shell {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid rgba(166, 124, 82, 0.2);
      box-shadow: 0 10px 30px rgba(66, 56, 46, 0.08);
      padding: 20px 16px 96px;
      position: relative;
      overflow: hidden;
    }

    /* TEXTURE */
    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z' /%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }
    .app-inner { position: relative; z-index: 1; }

    /* EDIT BUTTON */
    .edit-toggle {
      position: absolute; top: 18px; right: 18px; z-index: 50;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid var(--border-soft);
      padding: 4px 12px; border-radius: 99px;
      font-size: 0.75rem; color: var(--ink-muted);
      cursor: pointer;
    }

    /* HERO */
    .hero {
      background: #efece5;
      border-radius: 18px;
      padding: 24px 20px;
      margin-bottom: 24px;
    }
    .hero-title { font-size: 1.6rem; margin-top: 8px; }
    .hero-subtitle { font-size: 0.92rem; color: var(--ink-muted); margin-top: 8px; line-height: 1.6; }
    .eyebrow { font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-soft); font-weight: 500; }

    .hero-meta-row { display: flex; gap: 12px; margin-top: 16px; font-size: 0.85rem; color: var(--ink-muted); align-items: center; }
    .pill { background: #fff; padding: 4px 12px; border-radius: 99px; border: 1px solid rgba(0,0,0,0.05); }

    .hero-grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    @media(min-width: 600px) { .hero-grid { grid-template-columns: 1.6fr 1fr; } }

    .hero-secondary {
      background: #2c241b; border-radius: 14px; padding: 16px; color: #eaddcf;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .tags { display: flex; gap: 6px; margin-top: 8px; }
    .tag { padding: 2px 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; font-size: 0.7rem; }

    /* TIMELINE */
    .timeline { margin-top: 10px; padding-left: 10px; }
    .timeline-item { display: grid; grid-template-columns: 60px 1fr; gap: 16px; padding-bottom: 24px; position: relative; }
    .timeline-time { text-align: right; font-size: 0.85rem; color: var(--ink-muted); padding-top: 2px; position: relative; }
    .timeline-line { position: absolute; top: 24px; right: -8px; bottom: -16px; width: 1px; background: rgba(166, 124, 82, 0.3); }
    .timeline-item:last-child .timeline-line { display: none; }
    .timeline-dot { position: absolute; top: 6px; right: -12px; width: 9px; height: 9px; border-radius: 50%; background: #fff; border: 2px solid var(--accent); z-index: 1; }
    
    .timeline-card { background: #fff; border: 1px solid var(--border-soft); border-radius: 12px; padding: 14px 16px; }
    .timeline-title { font-size: 1rem; font-weight: 600; }
    .timeline-type { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--ink-soft); float: right; }
    .timeline-body { font-size: 0.9rem; margin-top: 8px; line-height: 1.6; }

    /* PHOTO BREAK (AI GEN) */
    .photo-break {
      margin: 24px 0 10px;
      background: #fff;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      overflow: hidden;
      display: grid; grid-template-columns: 1fr;
      min-height: 280px;
    }
    @media(min-width: 600px) { .photo-break { grid-template-columns: 1.4fr 1fr; } }

    .photo-wrapper {
      position: relative;
      background: #e0ddd5;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
    }

    .photo-img-element {
      width: 100%; height: 100%; object-fit: cover;
      opacity: 0; transition: opacity 1s ease;
    }
    .photo-img-element.loaded { opacity: 1; }

    /* AI Loading State */
    .ai-loader {
      position: absolute;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      color: var(--ink-muted);
      font-size: 0.75rem; letter-spacing: 0.1em;
      transition: opacity 0.3s;
    }
    .ai-loader.hidden { opacity: 0; pointer-events: none; }
    
    .spinner {
      width: 24px; height: 24px;
      border: 2px solid rgba(166, 124, 82, 0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .photo-content { padding: 24px; display: flex; flex-direction: column; justify-content: center; }

    /* NAV */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(253, 250, 246, 0.95);
      border-top: 1px solid var(--border-soft);
      backdrop-filter: blur(12px);
      padding: 10px 16px; display: flex; justify-content: center;
      z-index: 100;
    }
    .nav-scroll { display: flex; gap: 8px; overflow-x: auto; }
    .nav-btn {
      padding: 8px 14px; border-radius: 99px;
      border: 1px solid var(--border-soft); background: transparent;
      color: var(--ink-muted); font-size: 0.75rem; cursor: pointer;
      display: flex; align-items: center; gap: 6px;
    }
    .nav-btn.active { background: var(--ink-main); color: #fff; border-color: var(--ink-main); }
    .nav-btn-dot { width: 6px; height: 6px; border-radius: 50%; background: transparent; border: 1px solid currentColor; }
    .nav-btn.active .nav-btn-dot { background: var(--accent); border-color: var(--accent); }

    /* DRAWER */
    .drawer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fdfaf6; border-radius: 20px 20px 0 0;
      max-height: 85vh; transform: translateY(105%);
      transition: transform 0.3s; z-index: 160;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
    }
    .drawer.active { transform: translateY(0); }
    .drawer-header { padding: 16px 20px; border-bottom: 1px solid var(--border-soft); display: flex; justify-content: space-between; }
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 150; }
    .backdrop.active { opacity: 1; pointer-events: auto; }

  </style>
</head>
<body>

<div class="app-shell">
  <button id="edit-toggle" class="edit-toggle">‚úé EDIT</button>

  <div class="app-inner">
    <!-- Hero -->
    <header class="hero">
      <div class="hero-grid">
        <div>
          <div class="eyebrow" id="day-eyebrow">DAY 01 ¬∑ STRATEGY</div>
          <h1 class="hero-title" id="day-title">Arrival & Winter Gear</h1>
          <p class="hero-subtitle" id="day-subtitle">ÂæûÂ∑•‰ΩúÊ®°ÂºèÁôªÂá∫ÔºåÂ∞áÁ¨¨‰∏ÄÂ§©ÁöÑÈáçÈªûÊîæÂú®„ÄåÂÜ¨Ë£ùË£úÈΩä„ÄçËàá„ÄåË™øÊï¥ÁØÄÂ•è„Äç„ÄÇ</p>
          <div class="hero-meta-row">
            <div class="pill"><span id="day-date">12/15 Mon</span></div>
            <div>üìç <span id="day-location">KIX ¬∑ Rinku Town</span></div>
          </div>
        </div>
        <div class="hero-secondary">
          <div>
            <h3 style="font-size:0.8rem; letter-spacing:0.1em; color:#bcaaa4; margin:0 0 8px;">STRATEGY</h3>
            <p id="day-strategy" style="font-size:0.88rem; color:rgba(234, 221, 207, 0.9); margin:0;">Ëá®Á©∫ÂüéÊ†∏ÂøÉ‰ªªÂãôÔºö‰∏ÄÊ¨°Ëß£Ê±∫‰øùÊöñÂ§ñÂ•óËàáÈÖç‰ª∂„ÄÇ</p>
          </div>
          <div class="tags" id="day-tags"></div>
        </div>
      </div>
    </header>

    <!-- Timeline -->
    <main id="timeline" class="timeline"></main>

    <!-- AI Photo Break -->
    <div class="photo-break">
      <div class="photo-wrapper">
        <<img id="day-image" class="photo-img-element"
  src="data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%201600%201000%27%3E%3Cdefs%3E%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%3Cstop%20offset%3D%270%25%27%20stop-color%3D%27%23f6d365%27/%3E%3Cstop%20offset%3D%27100%25%27%20stop-color%3D%27%23fda085%27/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect%20width%3D%271600%27%20height%3D%271000%27%20fill%3D%27url(%23g)%27/%3E%3Ctext%20x%3D%2780%27%20y%3D%27160%27%20font-size%3D%2796%27%20font-family%3D%27system-ui%27%20fill%3D%27%232b2117%27%3Ev10%20TEST%20IMAGE%3C/text%3E%3C/svg%3E"
  alt="v10 test" />
>
        <div id="ai-loader" class="ai-loader">
          <div class="spinner"></div>
          <span>AI GENERATING...</span>
        </div>
      </div>
      <div class="photo-content">
        <div class="eyebrow">VIBE CHECK</div>
        <h3 id="photo-title">Title</h3>
        <p id="photo-desc">Description</p>
      </div>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <div class="nav-scroll" id="nav-container"></div>
</nav>

<!-- Drawer -->
<div class="backdrop" id="backdrop"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div style="font-weight:600;">TRIP CHEAT SHEET</div>
    <div style="cursor:pointer;" id="drawer-close">‚úï</div>
  </div>
  <div style="padding:20px;">
    <p><strong>Ê†∏ÂøÉÂéüÂâá</strong>: ÊÖ¢ÂçäÊãç √ó ÊúâÁ≠ñÁï•ÁöÑÂüéÂ∏ÇÊóÖË°å</p>
    <p><strong>‰ΩèÂÆø</strong>: GRANBELL HOTEL OSAKA NAMBA</p>
    <p><strong>Ëà™Áè≠</strong>: JL812 (Âéª) / JL815 (Âõû)</p>
  </div>
</div>

<script type="module">
  // --- AI CONFIGURATION ---
  const apiKey = ""; // API key injected by environment
  
  // High-Quality Photorealistic Prompts
  const PROMPTS = [
    "A cinematic wide shot of Rinku Town Ferris Wheel in Osaka at sunset, winter atmosphere, gentle sea waves in the foreground, soft golden hour lighting, photorealistic, 8k resolution, highly detailed.", // Day 1
    "A cozy street view of Kitahama river side in Osaka, retro brick architecture cafes, soft morning sunlight, peaceful urban river reflection, photorealistic, cinematic depth of field.", // Day 2
    "A serene photography of Osaka Castle moat reflection, winter trees with light snow dust, soft sunlight, peaceful park atmosphere, high resolution, photorealistic.", // Day 3
    "A close-up cinematic portrait of a deer in Nara Park, soft natural light filtering through forest trees, peaceful nature, mossy stone lanterns in background, photorealistic, 8k.", // Day 4
    "A cinematic view from Kansai International Airport observation deck, looking out at an airplane wing and the runway at twilight, blue hour sky, emotional travel vibe, photorealistic." // Day 5
  ];

  // --- DATA MODEL ---
  const itinerary = [
    {
      id: 0, label: "DAY 01", date: "12/15 Mon", loc: "KIX ¬∑ Rinku",
      title: "Arrival & Winter Gear", subtitle: "ÊäµÈÅîËàáÂÜ¨Ë£ùË£úÈΩäÔºöÂæûÂ∑•‰ΩúÊ®°ÂºèÁôªÂá∫„ÄÇ",
      strategy: "Ê†∏ÂøÉ‰ªªÂãôÔºöÂú®Ëá®Á©∫Âüé‰∏ÄÊ¨°Ëß£Ê±∫‰øùÊöñÂ§ñÂ•ó (TNF/Patagonia)ÔºåÈÅøÂÖçÂæåÁ∫åÂàÜÂøÉ„ÄÇ",
      tags: ["WINTER GEAR", "SLOW START"],
      photoTitle: "Ëá®Á©∫ÂüéÁöÑÊó•ËêΩ", photoDesc: "Êµ∑È¢®Áï•Â∏∂ÂØíÊÑèÔºåÊë©Â§©Ëº™‰∏ãÁöÑÂ§ïÈôΩÂÆ£ÂëäÂÅáÊúüÊ≠£ÂºèÈñãÂßã„ÄÇ",
      timeline: [
        { time: "11:50", title: "ÊäµÈÅîÈóúË•øÊ©üÂ†¥", type: "ARRIVAL", desc: "JL812 ËêΩÂú∞„ÄÇÊÑüÂèóÂ§ßÈò™ÁöÑÊ∞£Ê∫´ÔºåÁ¢∫Ë™ç ICOCA„ÄÇ" },
        { time: "13:30", title: "Ëá®Á©∫ÂüéÂçàÈ§ê", type: "LUNCH", desc: "Seaside Area ÁúãÊµ∑Áî®È§ê„ÄÇ" },
        { time: "15:00", title: "ÂÜ¨Ë£ùÊé°Ë≥º", type: "SHOPPING", desc: "Rinku Outlet ÈáçÈªûÔºöTNF, BEAMS„ÄÇË≤∑Â•ΩÂ§ñÂ•óÁõ¥Êé•Á©ø‰∏ä„ÄÇ" },
        { time: "19:00", title: "ÂÖ•‰ΩèÈõ£Ê≥¢", type: "HOTEL", desc: "Granbell Hotel Check-in„ÄÇ" }
      ]
    },
    {
      id: 1, label: "DAY 02", date: "12/16 Tue", loc: "Umeda ¬∑ Kitahama",
      title: "Urban Rhythm", subtitle: "Ê¢ÖÁî∞ÁöÑÊïàÁéáËàáÂåóÊø±ÁöÑÂÑ™ÈõÖ„ÄÇ",
      strategy: "‰∏äÂçàËß£Ê±∫ÂΩ©Â¶ùÔºå‰∏ãÂçàÂåóÊø±ÊîæÁ©∫„ÄÇ",
      tags: ["CITY", "CAFE"],
      photoTitle: "ÂåóÊø±ÁöÑÂØßÈùú", photoDesc: "Èõ£Ê≥¢ÁöÑÂñßÂõÇ‰πãÂ§ñÔºåÈÄôË£°ÊòØÂ§ßÈò™ÊúÄÂÉèÊ≠êÊ¥≤ÁöÑËßíËêΩ„ÄÇ",
      timeline: [
        { time: "10:00", title: "Ê¢ÖÁî∞Ë≥ºÁâ©", type: "SHOPPING", desc: "ÈéñÂÆöÔºöExcel, Canmake, 3COINS„ÄÇ" },
        { time: "13:30", title: "ÂåóÊø±Ê≤≥Áïî", type: "CAFE", desc: "Gokan Êú¨È§®Êàñ &ISLAND„ÄÇ" },
        { time: "15:30", title: "‰∏≠Â¥éÁî∫", type: "WALK", desc: "Êé¢Á¥¢ËÄÅÂ±ãÊîπÂª∫ÁöÑÂ∞èÂ∫ó„ÄÇ" },
        { time: "19:00", title: "ÈÅìÈ†ìÂ†Ä", type: "DINNER", desc: "Âë≥‰πÉÂÆ∂Â§ßÈò™Ááí„ÄÇ" }
      ]
    },
    {
      id: 2, label: "DAY 03", date: "12/17 Wed", loc: "Osaka Castle",
      title: "History & Green", subtitle: "Ë≠∑ÂüéÊ≤≥ÁöÑÂÄíÂΩ±ËàáÂÜ¨Êó•ÊöñÈôΩ„ÄÇ",
      strategy: "È´îÂäõË™øÁØÄÊó•Ôºå‰∏ç‰∏ÄÂÆöË¶ÅÁà¨Â§©ÂÆàÈñ£„ÄÇ",
      tags: ["PARK", "RELAX"],
      photoTitle: "Ë≠∑ÂüéÊ≤≥ÁöÑÂÄíÂΩ±", photoDesc: "‰∏çÈúÄË¶ÅÁà¨‰∏äÂ§©ÂÆàÈñ£ÔºåÂÖâÊòØÊ≤øËëóÁü≥ÁâÜËµ∞ÔºåÂ∞±ËÉΩÊÑüÂèóÂà∞Ê≠∑Âè≤ÁöÑÈáçÈáè„ÄÇ",
      timeline: [
        { time: "10:00", title: "Â§ßÈò™ÂüéÂÖ¨Âúí", type: "WALK", desc: "Â§ñÂúçÊï£Ê≠•ÔºåÁúãÈäÄÊùèËàáÁü≥ÁâÜ„ÄÇ" },
        { time: "12:30", title: "Jo-Terrace", type: "LUNCH", desc: "ÂÖ¨ÂúíÊóÅÁöÑË§áÂêàË®≠ÊñΩÁî®È§ê„ÄÇ" },
        { time: "15:00", title: "Â∏ÇÂçÄÂÇôÊ°à", type: "BUFFER", desc: "ÂøÉÈΩãÊ©ãË£úË≤®ÊàñÂõûÈ£ØÂ∫óÂçàÁù°„ÄÇ" },
        { time: "18:30", title: "Á¶èÂ§™ÈÉé", type: "DINNER", desc: "ËëóÂêçÁöÑËî•Ááí„ÄÇ" }
      ]
    },
    {
      id: 3, label: "DAY 04", date: "12/18 Thu", loc: "Nara Park",
      title: "Deer & Silence", subtitle: "Êï¥Ë∂üÊóÖÁ®ãÊúÄÂÆâÈùúÁöÑ‰∏ÄÂ§©„ÄÇ",
      strategy: "‰∏çÁúãÂú∞ÂúñÔºåÈ†ÜËëóÈπøÁöÑÊ≠•Ë™øËµ∞„ÄÇ",
      tags: ["NATURE", "DEER"],
      photoTitle: "Âè§ÈÉΩÁöÑÁúºÁ•û", photoDesc: "ÈÄôË£°ÁöÑÈπøÊØî‰∫∫Êõ¥ÂÉè‰∏ª‰∫∫„ÄÇ",
      timeline: [
        { time: "09:30", title: "ÂâçÂæÄÂ•àËâØ", type: "TRAIN", desc: "Êê≠‰πòËøëÈêµ„ÄÇ" },
        { time: "10:30", title: "Rokumei", type: "COFFEE", desc: "ÂÜ†ËªçÂíñÂï°Â•àËâØÊú¨Â∫ó„ÄÇ" },
        { time: "12:00", title: "ÂøóÊ¥•È¶ô", type: "LUNCH", desc: "ÈáúÈ£ØÔºåÊàñÂ•àËâØÁî∫ÂÆöÈ£ü„ÄÇ" },
        { time: "14:00", title: "Êò•Êó•Â§ßÁ§æ", type: "WALK", desc: "ÈÅøÈñãÈÅäÂÆ¢ÔºåËµ∞ÈÄ≤Ê®πÊûóË£°„ÄÇ" }
      ]
    },
    {
      id: 4, label: "DAY 05", date: "12/19 Fri", loc: "KIX Airport",
      title: "Sky & Reflection", subtitle: "ÈÄèÈÅéÊ©üÂ†¥ÁéªÁíÉÁ™óÂ•ΩÂ•ΩÈÅìÂà•„ÄÇ",
      strategy: "ÂõûÁ®ãÈáçÈªûÊòØÂÑÄÂºèÊÑü„ÄÇ",
      tags: ["AIRPORT", "BYE"],
      photoTitle: "Èõ¢ÈñãÁöÑË¶ñËßí", photoDesc: "ÈÄèÈÅéÊ©üÂ†¥ÁöÑÁéªÁíÉÁ™óÔºåÂÜçÁúã‰∏ÄÊ¨°ÈÄôÂ∫ßÂüéÂ∏ÇÁöÑÂ§©Á©∫„ÄÇ",
      timeline: [
        { time: "10:00", title: "ÈÄÄÊàø", type: "CHECKOUT", desc: "Ë°åÊùéÂØÑÊîæÔºåË£úÊúÄÂæåÊ∂àËÄóÂìÅ„ÄÇ" },
        { time: "14:30", title: "ÂâçÂæÄÊ©üÂ†¥", type: "MOVE", desc: "Êê≠‰πò Rapi:t„ÄÇ" },
        { time: "16:00", title: "Blue Bottle", type: "COFFEE", desc: "KIX ÊúÄÂæå‰∏ÄÊùØÂíñÂï°„ÄÇ" }
      ]
    }
  ];

  // --- STATE ---
  const state = {
    activeDay: 0,
    imageCache: {} // Stores base64 images: { 0: "data...", 1: "data..." }
  };

  const els = {
    title: document.getElementById('day-title'),
    subtitle: document.getElementById('day-subtitle'),
    date: document.getElementById('day-date'),
    loc: document.getElementById('day-location'),
    strategy: document.getElementById('day-strategy'),
    tags: document.getElementById('day-tags'),
    timeline: document.getElementById('timeline'),
    nav: document.getElementById('nav-container'),
    // Photo
    photoImg: document.getElementById('ai-image'),
    loader: document.getElementById('ai-loader'),
    photoTitle: document.getElementById('photo-title'),
    photoDesc: document.getElementById('photo-desc'),
    // Drawer
    drawer: document.getElementById('drawer'),
    backdrop: document.getElementById('backdrop'),
    drawerClose: document.getElementById('drawer-close')
  };

  // --- AI GENERATION LOGIC ---
  async function generateDayImage(dayIndex) {
    if (state.imageCache[dayIndex]) {
      return state.imageCache[dayIndex];
    }

    try {
      const prompt = PROMPTS[dayIndex];
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            instances: [{ prompt: prompt }],
            parameters: { sampleCount: 1 }
          })
        }
      );

      if (!response.ok) throw new Error("AI Gen Failed");
      
      const data = await response.json();
      const base64 = data.predictions[0].bytesBase64Encoded;
      const dataUrl = `data:image/png;base64,${base64}`;
      
      // Cache it
      state.imageCache[dayIndex] = dataUrl;
      return dataUrl;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  async function loadDay(idx) {
    state.activeDay = idx;
    const data = itinerary[idx];

    // Update UI Text
    els.title.textContent = data.title;
    els.subtitle.textContent = data.subtitle;
    els.date.textContent = data.date;
    els.loc.textContent = data.loc;
    els.strategy.textContent = data.strategy;
    els.tags.innerHTML = data.tags.map(t => `<span class="tag">${t}</span>`).join('');
    els.photoTitle.textContent = data.photoTitle;
    els.photoDesc.textContent = data.photoDesc;

    // Render Timeline
    els.timeline.innerHTML = data.timeline.map(item => `
      <div class="timeline-item">
        <div class="timeline-time">
          ${item.time}
          <div class="timeline-dot"></div>
          <div class="timeline-line"></div>
        </div>
        <article class="timeline-card">
          <div class="timeline-title">${item.title} <span class="timeline-type">${item.type}</span></div>
          <div class="timeline-body">${item.desc}</div>
        </article>
      </div>
    `).join('');

    // Update Nav Active State
    document.querySelectorAll('.nav-btn').forEach((btn, i) => {
      if (i < 5) { // First 5 are days
        btn.classList.toggle('active', i === idx);
        // Reset dot color
        const dot = btn.querySelector('.nav-btn-dot');
        if(dot) dot.style.backgroundColor = i === idx ? 'var(--accent)' : 'transparent';
        if(dot) dot.style.borderColor = i === idx ? 'var(--accent)' : 'currentColor';
      }
    });

    // Handle AI Image
    els.photoImg.classList.remove('loaded');
    els.loader.classList.remove('hidden'); // Show loader
    
    // Check Cache or Generate
    if (state.imageCache[idx]) {
      // Use Cached
      els.photoImg.src = state.imageCache[idx];
      els.photoImg.onload = () => {
        els.loader.classList.add('hidden');
        els.photoImg.classList.add('loaded');
      };
    } else {
      // Generate Fresh
      const imgUrl = await generateDayImage(idx);
      if (imgUrl) {
        els.photoImg.src = imgUrl;
        els.photoImg.onload = () => {
          els.loader.classList.add('hidden');
          els.photoImg.classList.add('loaded');
        };
      } else {
        // Fallback if AI fails
        els.loader.classList.add('hidden');
        els.photoImg.alt = "Image Generation Failed. Refresh to retry.";
      }
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function init() {
    // Render Nav
    const frag = document.createDocumentFragment();
    itinerary.forEach((d, i) => {
      const btn = document.createElement('button');
      btn.className = `nav-btn ${i===0?'active':''}`;
      btn.innerHTML = `<span class="nav-btn-dot"></span><span>${d.label}</span>`;
      btn.onclick = () => loadDay(i);
      frag.appendChild(btn);
    });
    // Add TRIP button
    const tripBtn = document.createElement('button');
    tripBtn.className = 'nav-btn special';
    tripBtn.innerHTML = `<span>TRIP</span>`;
    tripBtn.style.borderColor = 'var(--accent)';
    tripBtn.style.color = 'var(--ink-accent)';
    tripBtn.onclick = openDrawer;
    frag.appendChild(tripBtn);
    
    els.nav.appendChild(frag);

    // Event Listeners
    document.getElementById('edit-toggle').onclick = () => {
      const editing = document.body.classList.toggle('editing');
      document.querySelectorAll('.timeline-title, .timeline-body').forEach(el => {
        el.contentEditable = editing;
        if(editing) el.style.outline = "1px dashed var(--accent)";
        else el.style.outline = "none";
      });
    };

    els.drawerClose.onclick = closeDrawer;
    els.backdrop.onclick = closeDrawer;

    // Load Initial Day
    loadDay(0);
  }

  function openDrawer() {
    els.drawer.classList.add('active');
    els.backdrop.classList.add('active');
  }
  function closeDrawer() {
    els.drawer.classList.remove('active');
    els.backdrop.classList.remove('active');
  }

  init();
</script>
</body>
</html>

